<!-- templates/mexc.html -->
{% extends "base.html" %}

{% block title %}MEXC Market Making - BlockAI Pure MM{% endblock %}

{% block extra_css %}
<style>
    /* Tab styling */
    .instance-tab {
        cursor: pointer;
    }
    
    .instance-tab.active {
        font-weight: bold;
        background-color: #6441A4 !important;
        border-color: #6441A4 !important;
    }
    
    .tab-instance {
        display: none;
    }
    
    .tab-instance.active {
        display: block;
    }
    
    /* Log styling */
    .transaction-log {
        max-height: 300px;
        overflow-y: auto;
        background-color: #1a1a1a;
        color: #f8f8f8;
        font-family: monospace;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
    }
    
    .log-entry {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
    }
    
    .log-success {
        color: #00db87;
    }
    
    .log-error {
        color: #ff4d4d;
    }
    
    .log-info {
        color: #4da6ff;
    }
    
    .log-warning {
        color: #ffcc00;
    }
    
    /* Form fields */
    .form-label {
        font-weight: 500;
    }
    
    .form-text {
        font-size: 0.8rem;
    }
    
    /* Accordion styling */
    .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
        color: #0c63e4;
    }
    
    /* Switch sections */
    .section-switch {
        padding: 10px 0;
        margin: 10px 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
    }
    
    /* Toggle */
    .form-check-input:checked {
        background-color: #6441A4;
        border-color: #6441A4;
    }
    
    /* MEXC theme */
    .bg-mexc {
        background-color: #6441A4;
        color: white;
    }
    
    .btn-mexc {
        background-color: #6441A4;
        color: white;
    }
    
    .btn-mexc:hover {
        background-color: #5c3a96;
        color: white;
    }
    
    .mexc-color {
        color: #6441A4;
    }
    
    /* Copy button */
    .copy-btn {
        cursor: pointer;
    }
    
    /* Status indicator */
    .status-indicator {
        width: 12px;
        height: 12px;
        display: inline-block;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-running {
        background-color: #00db87;
    }
    
    .status-stopped {
        background-color: #ff4d4d;
    }
    
    .status-paused {
        background-color: #ffcc00;
    }
    
    /* Tooltip */
    .custom-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
    }
    
    .custom-tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .custom-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">
        <span class="mexc-color">MEXC</span> Market Making
        <small class="text-muted fs-6">Advanced market making for MEXC exchange</small>
    </h1>
    
    <!-- Instance Tabs -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Instances</h5>
                <button id="addInstanceBtn" class="btn btn-sm btn-success">
                    <i class="bi bi-plus-lg"></i> Add Instance
                </button>
            </div>
        </div>
        <div class="card-body">
            <p>Each instance can run market making for a different trading pair with separate API keys and configurations.</p>
            
            <div class="d-flex flex-wrap mb-3" id="instanceTabs">
                <button class="btn btn-outline-primary me-2 mb-2 instance-tab active" data-instance="1">Instance 1</button>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Each instance will continue to run in the background even if you navigate away from this page.
            </div>
        </div>
    </div>
    
    <!-- Instance Configuration -->
    <div id="instancesContainer">
        <!-- Instance 1 -->
        <div class="tab-instance active" data-instance="1">
            <div class="card mb-4">
                <div class="card-header bg-mexc text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Instance 1 Configuration</h5>
                        <div>
                            <span class="status-indicator status-stopped" id="statusIndicator-1"></span>
                            <span id="statusText-1">Stopped</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form id="mexcForm-1" class="mexc-form">
                        <input type="hidden" id="instanceId-1" name="instanceId" value="">
                        
                        <!-- API Configuration -->
                        <div class="accordion mb-4" id="apiAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="apiHeading-1">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#apiCollapse-1" aria-expanded="true" aria-controls="apiCollapse-1">
                                        <i class="bi bi-key me-2"></i> API Configuration
                                    </button>
                                </h2>
                                <div id="apiCollapse-1" class="accordion-collapse collapse show" aria-labelledby="apiHeading-1" data-bs-parent="#apiAccordion-1">
                                    <div class="accordion-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="apiKey-1" class="form-label">API Key</label>
                                                <input type="password" class="form-control" id="apiKey-1" name="apiKey" placeholder="Enter your MEXC API key">
                                                <div class="form-text">Your MEXC API key with trading permissions</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="apiSecret-1" class="form-label">API Secret</label>
                                                <input type="password" class="form-control" id="apiSecret-1" name="apiSecret" placeholder="Enter your MEXC API secret">
                                                <div class="form-text">Your MEXC API secret (stored locally only)</div>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="saveCredentials-1" name="saveCredentials">
                                            <label class="form-check-label" for="saveCredentials-1">
                                                Save API credentials (encrypted in local storage)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trading Pair Configuration -->
                        <div class="accordion mb-4" id="tradingPairAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="tradingPairHeading-1">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tradingPairCollapse-1" aria-expanded="true" aria-controls="tradingPairCollapse-1">
                                        <i class="bi bi-currency-exchange me-2"></i> Trading Pair Configuration
                                    </button>
                                </h2>
                                <div id="tradingPairCollapse-1" class="accordion-collapse collapse show" aria-labelledby="tradingPairHeading-1" data-bs-parent="#tradingPairAccordion-1">
                                    <div class="accordion-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="tradingPair-1" class="form-label">Trading Pair</label>
                                                <input type="text" class="form-control" id="tradingPair-1" name="tradingPair" placeholder="e.g. BTC-USDT" value="BTC-USDT">
                                                <div class="form-text">Format: BASE-QUOTE (e.g. BTC-USDT)</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="orderAmount-1" class="form-label">Order Amount</label>
                                                <input type="number" class="form-control" id="orderAmount-1" name="orderAmount" placeholder="e.g. 0.001" value="0.001" min="0" step="0.000001">
                                                <div class="form-text">Base asset amount per order</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Market Making Parameters -->
                        <div class="accordion mb-4" id="marketMakingAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="marketMakingHeading-1">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#marketMakingCollapse-1" aria-expanded="true" aria-controls="marketMakingCollapse-1">
                                        <i class="bi bi-sliders me-2"></i> Market Making Parameters
                                    </button>
                                </h2>
                                <div id="marketMakingCollapse-1" class="accordion-collapse collapse show" aria-labelledby="marketMakingHeading-1" data-bs-parent="#marketMakingAccordion-1">
                                    <div class="accordion-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="bidSpread-1" class="form-label">Bid Spread (%)</label>
                                                <input type="number" class="form-control" id="bidSpread-1" name="bidSpread" placeholder="e.g. 0.2" value="0.2" min="0" step="0.01">
                                                <div class="form-text">Percentage below mid price for buy orders</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="askSpread-1" class="form-label">Ask Spread (%)</label>
                                                <input type="number" class="form-control" id="askSpread-1" name="askSpread" placeholder="e.g. 0.2" value="0.2" min="0" step="0.01">
                                                <div class="form-text">Percentage above mid price for sell orders</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="orderRefreshTime-1" class="form-label">Order Refresh Time (seconds)</label>
                                                <input type="number" class="form-control" id="orderRefreshTime-1" name="orderRefreshTime" placeholder="e.g. 30" value="30" min="1" step="1">
                                                <div class="form-text">Time between order refreshes</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="maxOrderAge-1" class="form-label">Max Order Age (seconds)</label>
                                                <input type="number" class="form-control" id="maxOrderAge-1" name="maxOrderAge" placeholder="e.g. 1800" value="1800" min="0" step="1">
                                                <div class="form-text">Maximum time an order can remain active</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="orderRefreshTolerancePct-1" class="form-label">Order Refresh Tolerance (%)</label>
                                                <input type="number" class="form-control" id="orderRefreshTolerancePct-1" name="orderRefreshTolerancePct" placeholder="e.g. 0" value="0" min="0" step="0.01">
                                                <div class="form-text">Tolerance for price changes before refreshing orders</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="minimumSpread-1" class="form-label">Minimum Spread (%)</label>
                                                <input type="number" class="form-control" id="minimumSpread-1" name="minimumSpread" placeholder="e.g. 0" value="0" min="0" step="0.01">
                                                <div class="form-text">Minimum acceptable spread between buy and sell orders</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Levels -->
                        <div class="accordion mb-4" id="orderLevelsAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="orderLevelsHeading-1">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#orderLevelsCollapse-1" aria-expanded="false" aria-controls="orderLevelsCollapse-1">
                                        <i class="bi bi-layers me-2"></i> Order Levels
                                    </button>
                                </h2>
                                <div id="orderLevelsCollapse-1" class="accordion-collapse collapse" aria-labelledby="orderLevelsHeading-1" data-bs-parent="#orderLevelsAccordion-1">
                                    <div class="accordion-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="orderLevels-1" class="form-label">Number of Order Levels</label>
                                                <input type="number" class="form-control" id="orderLevels-1" name="orderLevels" placeholder="e.g. 1" value="1" min="1" max="10" step="1">
                                                <div class="form-text">Number of order levels on each side</div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="orderLevelAmount-1" class="form-label">Level Amount Increment</label>
                                                <input type="number" class="form-control" id="orderLevelAmount-1" name="orderLevelAmount" placeholder="e.g. 0" value="0" min="0" step="0.000001">
                                                <div class="form-text">Additional amount for each level</div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="orderLevelSpread-1" class="form-label">Level Spread (%)</label>
                                                <input type="number" class="form-control" id="orderLevelSpread-1" name="orderLevelSpread" placeholder="e.g. 0.01" value="0.01" min="0" step="0.01">
                                                <div class="form-text">Additional spread for each level</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Risk Management -->
                        <div class="accordion mb-4" id="riskManagementAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="riskManagementHeading-1">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#riskManagementCollapse-1" aria-expanded="false" aria-controls="riskManagementCollapse-1">
                                        <i class="bi bi-shield-check me-2"></i> Risk Management
                                    </button>
                                </h2>
                                <div id="riskManagementCollapse-1" class="accordion-collapse collapse" aria-labelledby="riskManagementHeading-1" data-bs-parent="#riskManagementAccordion-1">
                                    <div class="accordion-body">
                                        <!-- Inventory Skew -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="inventorySkewEnabled-1" name="inventorySkewEnabled">
                                                <label class="form-check-label" for="inventorySkewEnabled-1">
                                                    <strong>Inventory Skew</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 inventory-skew-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="inventoryTargetBasePct-1" class="form-label">Inventory Target Base %</label>
                                                        <input type="number" class="form-control" id="inventoryTargetBasePct-1" name="inventoryTargetBasePct" placeholder="e.g. 50" value="50" min="0" max="100" step="1">
                                                        <div class="form-text">Target percentage of base asset in portfolio</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="inventoryRangeMultiplier-1" class="form-label">Inventory Range Multiplier</label>
                                                        <input type="number" class="form-control" id="inventoryRangeMultiplier-1" name="inventoryRangeMultiplier" placeholder="e.g. 1" value="1" min="0" step="0.1">
                                                        <div class="form-text">Multiplier for inventory range</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Stop Loss -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="stopLossEnabled-1" name="stopLossEnabled">
                                                <label class="form-check-label" for="stopLossEnabled-1">
                                                    <strong>Stop Loss</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 stop-loss-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="stopLossSpread-1" class="form-label">Stop Loss Spread (%)</label>
                                                        <input type="number" class="form-control" id="stopLossSpread-1" name="stopLossSpread" placeholder="e.g. 20" value="20" min="0" max="100" step="0.1">
                                                        <div class="form-text">Percentage below cost basis to trigger stop loss</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="stopLossCooldown-1" class="form-label">Stop Loss Cooldown (seconds)</label>
                                                        <input type="number" class="form-control" id="stopLossCooldown-1" name="stopLossCooldown" placeholder="e.g. 60" value="60" min="0" step="1">
                                                        <div class="form-text">Cooldown period between stop loss triggers</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Order Size Controls -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="orderSizeControlsEnabled-1" name="orderSizeControlsEnabled">
                                                <label class="form-check-label" for="orderSizeControlsEnabled-1">
                                                    <strong>Order Size Controls</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 order-size-controls-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label for="minOrderSize-1" class="form-label">Minimum Order Size</label>
                                                        <input type="number" class="form-control" id="minOrderSize-1" name="minOrderSize" placeholder="Optional" step="0.000001" min="0">
                                                        <div class="form-text">Minimum order size in base asset</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="maxOrderSize-1" class="form-label">Maximum Order Size</label>
                                                        <input type="number" class="form-control" id="maxOrderSize-1" name="maxOrderSize" placeholder="Optional" step="0.000001" min="0">
                                                        <div class="form-text">Maximum order size in base asset</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="maxPositionSize-1" class="form-label">Maximum Position Size</label>
                                                        <input type="number" class="form-control" id="maxPositionSize-1" name="maxPositionSize" placeholder="Optional" step="0.000001" min="0">
                                                        <div class="form-text">Maximum position size in base asset</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Price Bands -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="priceBandsEnabled-1" name="priceBandsEnabled">
                                                <label class="form-check-label" for="priceBandsEnabled-1">
                                                    <strong>Price Bands</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 price-bands-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="priceCeiling-1" class="form-label">Price Ceiling</label>
                                                        <input type="number" class="form-control" id="priceCeiling-1" name="priceCeiling" placeholder="Optional" step="0.000001" min="0">
                                                        <div class="form-text">Upper price limit (absolute price)</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="priceFloor-1" class="form-label">Price Floor</label>
                                                        <input type="number" class="form-control" id="priceFloor-1" name="priceFloor" placeholder="Optional" step="0.000001" min="0">
                                                        <div class="form-text">Lower price limit (absolute price)</div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <label for="priceBandRefreshTime-1" class="form-label">Refresh Time (seconds)</label>
                                                        <input type="number" class="form-control" id="priceBandRefreshTime-1" name="priceBandRefreshTime" placeholder="e.g. 86400" value="86400" min="0" step="1">
                                                        <div class="form-text">Time between price band updates</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="priceCeilingPct-1" class="form-label">Ceiling %</label>
                                                        <input type="number" class="form-control" id="priceCeilingPct-1" name="priceCeilingPct" placeholder="e.g. 1" value="1" step="0.01">
                                                        <div class="form-text">% above mid price for ceiling</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label for="priceFloorPct-1" class="form-label">Floor %</label>
                                                        <input type="number" class="form-control" id="priceFloorPct-1" name="priceFloorPct" placeholder="e.g. -1" value="-1" step="0.01">
                                                        <div class="form-text">% below mid price for floor</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Settings -->
                        <div class="accordion mb-4" id="advancedSettingsAccordion-1">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="advancedSettingsHeading-1">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSettingsCollapse-1" aria-expanded="false" aria-controls="advancedSettingsCollapse-1">
                                        <i class="bi bi-gear me-2"></i> Advanced Settings
                                    </button>
                                </h2>
                                <div id="advancedSettingsCollapse-1" class="accordion-collapse collapse" aria-labelledby="advancedSettingsHeading-1" data-bs-parent="#advancedSettingsAccordion-1">
                                    <div class="accordion-body">
                                        <!-- Hanging Orders -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="hangingOrdersEnabled-1" name="hangingOrdersEnabled">
                                                <label class="form-check-label" for="hangingOrdersEnabled-1">
                                                    <strong>Hanging Orders</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 hanging-orders-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="hangingOrdersCancelPct-1" class="form-label">Cancel Threshold (%)</label>
                                                        <input type="number" class="form-control" id="hangingOrdersCancelPct-1" name="hangingOrdersCancelPct" placeholder="e.g. 10" value="10" min="0" max="100" step="0.1">
                                                        <div class="form-text">Cancel hanging orders when spread exceeds this %</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Order Optimization -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="orderOptimizationEnabled-1" name="orderOptimizationEnabled">
                                                <label class="form-check-label" for="orderOptimizationEnabled-1">
                                                    <strong>Order Optimization</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 order-optimization-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="askOrderOptimizationDepth-1" class="form-label">Ask Optimization Depth</label>
                                                        <input type="number" class="form-control" id="askOrderOptimizationDepth-1" name="askOrderOptimizationDepth" placeholder="e.g. 0" value="0" min="0" step="0.000001">
                                                        <div class="form-text">Volume to look at for ask optimization</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="bidOrderOptimizationDepth-1" class="form-label">Bid Optimization Depth</label>
                                                        <input type="number" class="form-control" id="bidOrderOptimizationDepth-1" name="bidOrderOptimizationDepth" placeholder="e.g. 0" value="0" min="0" step="0.000001">
                                                        <div class="form-text">Volume to look at for bid optimization</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Volatility Adjustment -->
                                        <div class="section-switch">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="volatilityAdjustment-1" name="volatilityAdjustment">
                                                <label class="form-check-label" for="volatilityAdjustment-1">
                                                    <strong>Volatility Adjustment</strong>
                                                </label>
                                            </div>
                                            <div class="mt-3 volatility-adjustment-options" style="display: none;">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="volatilityAdjustmentMultiplier-1" class="form-label">Adjustment Multiplier</label>
                                                        <input type="number" class="form-control" id="volatilityAdjustmentMultiplier-1" name="volatilityAdjustmentMultiplier" placeholder="e.g. 1" value="1" min="0" step="0.1">
                                                        <div class="form-text">How much volatility affects spread</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Fill Order Delay -->
                                        <div class="row mb-3 mt-4">
                                            <div class="col-md-6">
                                                <label for="filledOrderDelay-1" class="form-label">Filled Order Delay (seconds)</label>
                                                <input type="number" class="form-control" id="filledOrderDelay-1" name="filledOrderDelay" placeholder="e.g. 60" value="60" min="0" step="1">
                                                <div class="form-text">Delay after an order is filled before placing new orders</div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mt-4">
                                                    <input class="form-check-input" type="checkbox" id="addTransactionCosts-1" name="addTransactionCosts">
                                                    <label class="form-check-label" for="addTransactionCosts-1">
                                                        Add Transaction Costs to Price
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Trading Hours -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="tradingHourStart-1" class="form-label">Trading Hour Start</label>
                                                <input type="number" class="form-control" id="tradingHourStart-1" name="tradingHourStart" placeholder="e.g. 0" value="0" min="0" max="24" step="1">
                                                <div class="form-text">Hour to start trading (24-hour format, 0-24)</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="tradingHourEnd-1" class="form-label">Trading Hour End</label>
                                                <input type="number" class="form-control" id="tradingHourEnd-1" name="tradingHourEnd" placeholder="e.g. 24" value="24" min="0" max="24" step="1">
                                                <div class="form-text">Hour to end trading (24-hour format, 0-24)</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Cancel Confirmation -->
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="shouldWaitCancelConfirmation-1" name="shouldWaitCancelConfirmation" checked>
                                            <label class="form-check-label" for="shouldWaitCancelConfirmation-1">
                                                Wait for Order Cancel Confirmation
                                            </label>
                                            <div class="form-text">Wait for orders to be cancelled before placing new ones</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-mexc btn-lg start-button" data-instance="1">
                                <i class="bi bi-play-fill"></i> Start Market Making
                            </button>
                            <button type="button" class="btn btn-danger btn-lg stop-button" data-instance="1" style="display:none;">
                                <i class="bi bi-stop-fill"></i> Stop Market Making
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Transaction Log -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Transaction Log</h5>
                        <button class="btn btn-sm btn-secondary clear-log-btn" data-instance="1">
                            <i class="bi bi-trash"></i> Clear Log
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="transaction-log" id="transactionLog-1">
                        <div class="log-entry log-info">MEXC Market Maker initialized. Configure your settings and click "Start Market Making" to begin.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional instances will be dynamically added here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let instanceCount = 1;
        const MAX_INSTANCES = 10;
        const instances = {};
        
        // Initialize event listeners for the first instance
        initializeInstance(1);
        
        // Add instance button event listener
        document.getElementById('addInstanceBtn').addEventListener('click', addNewInstance);
        
        // Add a new instance
        function addNewInstance() {
            if (instanceCount >= MAX_INSTANCES) {
                alert(`Maximum of ${MAX_INSTANCES} instances allowed.`);
                return;
            }
            
            instanceCount++;
            
            // Create tab button
            const tabsContainer = document.getElementById('instanceTabs');
            const newTab = document.createElement('button');
            newTab.className = 'btn btn-outline-primary me-2 mb-2 instance-tab';
            newTab.dataset.instance = instanceCount;
            newTab.textContent = `Instance ${instanceCount}`;
            
            newTab.addEventListener('click', function() {
                switchInstance(instanceCount);
            });
            
            tabsContainer.appendChild(newTab);
            
            // Clone the first instance
            const instancesContainer = document.getElementById('instancesContainer');
            const firstInstance = document.querySelector('.tab-instance[data-instance="1"]');
            const newInstance = firstInstance.cloneNode(true);
            
            // Update instance number and IDs
            newInstance.dataset.instance = instanceCount;
            newInstance.classList.remove('active');
            
            // Update all IDs within the new instance
            const elementsWithId = newInstance.querySelectorAll('[id]');
            elementsWithId.forEach(el => {
                el.id = el.id.replace(/-1($|-)/, `-${instanceCount}$1`);
            });
            
            // Update all data-instance attributes
            const elementsWithDataInstance = newInstance.querySelectorAll('[data-instance]');
            elementsWithDataInstance.forEach(el => {
                el.dataset.instance = instanceCount;
            });
            
            // Update all data-bs-target attributes for accordion
            const accordionButtons = newInstance.querySelectorAll('.accordion-button');
            accordionButtons.forEach(btn => {
                if (btn.getAttribute('data-bs-target')) {
                    btn.setAttribute('data-bs-target', btn.getAttribute('data-bs-target').replace(/-1($|-)/, `-${instanceCount}$1`));
                }
                
                if (btn.getAttribute('aria-controls')) {
                    btn.setAttribute('aria-controls', btn.getAttribute('aria-controls').replace(/-1($|-)/, `-${instanceCount}$1`));
                }
            });
            
            // Update all form elements
            const formElements = newInstance.querySelectorAll('form[id^="mexcForm-"]');
            formElements.forEach(form => {
                form.id = `mexcForm-${instanceCount}`;
            });
            
            // Update form inputs
            const formInputs = newInstance.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                if (input.id && input.id.includes('-1')) {
                    input.id = input.id.replace(/-1($|-)/, `-${instanceCount}$1`);
                }
                if (input.name && input.name.includes('-1')) {
                    input.name = input.name.replace(/-1($|-)/, `-${instanceCount}$1`);
                }
            });
            
            // Update header
            const headerTitle = newInstance.querySelector('.card-header h5');
            if (headerTitle) {
                headerTitle.textContent = `Instance ${instanceCount} Configuration`;
            }
            
            // Reset transaction log
            const transactionLog = newInstance.querySelector('.transaction-log');
            if (transactionLog) {
                transactionLog.innerHTML = '<div class="log-entry log-info">MEXC Market Maker initialized. Configure your settings and click "Start Market Making" to begin.</div>';
            }
            
            // Add to container
            instancesContainer.appendChild(newInstance);
            
            // Initialize the new instance
            initializeInstance(instanceCount);
            
            // Switch to the new instance
            switchInstance(instanceCount);
        }
        
        // Initialize instance event listeners
        function initializeInstance(instanceId) {
            // Create the instance object
            instances[instanceId] = {
                id: `instance_${Date.now()}_${instanceId}`,
                status: 'stopped',
                running: false,
                config: {}
            };
            
            setupSwitches(instanceId);
            setupButtons(instanceId);
            setupFormSave(instanceId);
            loadSavedConfig(instanceId);
        }
        
        // Set up toggle switches
        function setupSwitches(instanceId) {
            // Inventory Skew
            const inventorySkewSwitch = document.getElementById(`inventorySkewEnabled-${instanceId}`);
            const inventorySkewOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .inventory-skew-options`);
            
            inventorySkewSwitch.addEventListener('change', function() {
                inventorySkewOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Stop Loss
            const stopLossSwitch = document.getElementById(`stopLossEnabled-${instanceId}`);
            const stopLossOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .stop-loss-options`);
            
            stopLossSwitch.addEventListener('change', function() {
                stopLossOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Order Size Controls
            const orderSizeControlsSwitch = document.getElementById(`orderSizeControlsEnabled-${instanceId}`);
            const orderSizeControlsOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .order-size-controls-options`);
            
            orderSizeControlsSwitch.addEventListener('change', function() {
                orderSizeControlsOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Price Bands
            const priceBandsSwitch = document.getElementById(`priceBandsEnabled-${instanceId}`);
            const priceBandsOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .price-bands-options`);
            
            priceBandsSwitch.addEventListener('change', function() {
                priceBandsOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Hanging Orders
            const hangingOrdersSwitch = document.getElementById(`hangingOrdersEnabled-${instanceId}`);
            const hangingOrdersOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .hanging-orders-options`);
            
            hangingOrdersSwitch.addEventListener('change', function() {
                hangingOrdersOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Order Optimization
            const orderOptimizationSwitch = document.getElementById(`orderOptimizationEnabled-${instanceId}`);
            const orderOptimizationOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .order-optimization-options`);
            
            orderOptimizationSwitch.addEventListener('change', function() {
                orderOptimizationOptions.style.display = this.checked ? 'block' : 'none';
            });
            
            // Volatility Adjustment
            const volatilityAdjustmentSwitch = document.getElementById(`volatilityAdjustment-${instanceId}`);
            const volatilityAdjustmentOptions = document.querySelector(`.tab-instance[data-instance="${instanceId}"] .volatility-adjustment-options`);
            
            volatilityAdjustmentSwitch.addEventListener('change', function() {
                volatilityAdjustmentOptions.style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Setup buttons for the instance
        function setupButtons(instanceId) {
            // Start button
            const startButton = document.querySelector(`.start-button[data-instance="${instanceId}"]`);
            startButton.addEventListener('click', function() {
                startMarketMaking(instanceId);
            });
            
            // Stop button
            const stopButton = document.querySelector(`.stop-button[data-instance="${instanceId}"]`);
            stopButton.addEventListener('click', function() {
                stopMarketMaking(instanceId);
            });
            
            // Clear log button
            const clearLogButton = document.querySelector(`.clear-log-btn[data-instance="${instanceId}"]`);
            clearLogButton.addEventListener('click', function() {
                clearTransactionLog(instanceId);
            });
        }
        
        // Setup form save event
        function setupFormSave(instanceId) {
            const form = document.getElementById(`mexcForm-${instanceId}`);
            const formInputs = form.querySelectorAll('input, select, textarea');
            
            formInputs.forEach(input => {
                input.addEventListener('change', function() {
                    saveConfig(instanceId);
                    
                    // Update the running instance if needed
                    if (instances[instanceId].running) {
                        updateInstance(instanceId);
                    }
                });
            });
        }
        
        // Switch between instances
        function switchInstance(instanceId) {
            // Update active tab
            const allTabs = document.querySelectorAll('.instance-tab');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const selectedTab = document.querySelector(`.instance-tab[data-instance="${instanceId}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update active instance content
            const allInstances = document.querySelectorAll('.tab-instance');
            allInstances.forEach(instance => {
                instance.classList.remove('active');
            });
            
            const selectedInstance = document.querySelector(`.tab-instance[data-instance="${instanceId}"]`);
            if (selectedInstance) {
                selectedInstance.classList.add('active');
            }
        }
        
        // Start market making
        function startMarketMaking(instanceId) {
            // Get form data
            const form = document.getElementById(`mexcForm-${instanceId}`);
            const formData = new FormData(form);
            const config = {};
            
            // Convert form data to JavaScript object
            for (let [key, value] of formData.entries()) {
                // Convert boolean values
                if (value === 'on') {
                    value = true;
                } else if (key.endsWith('Enabled') && !formData.has(key)) {
                    value = false;
                }
                
                // Convert numeric values
                if (!isNaN(value) && value !== '' && !key.includes('Key') && !key.includes('Secret')) {
                    value = parseFloat(value);
                }
                
                config[key] = value;
            }
            
            // Add instance ID
            config.instanceId = instances[instanceId].id;
            config.trading_pair = document.getElementById(`tradingPair-${instanceId}`).value;
            
            // Validate required fields
            if (!config.apiKey || !config.apiSecret) {
                addLogEntry(instanceId, 'API Key and Secret are required.', 'error');
                return;
            }
            
            if (!config.trading_pair) {
                addLogEntry(instanceId, 'Trading pair is required.', 'error');
                return;
            }
            
            // Update the config in the instances object
            instances[instanceId].config = config;
            
            // Save credentials if enabled
            if (config.saveCredentials) {
                saveEncryptedCredentials(instanceId, config.apiKey, config.apiSecret);
            }
            
            // Update UI
            const startButton = document.querySelector(`.start-button[data-instance="${instanceId}"]`);
            const stopButton = document.querySelector(`.stop-button[data-instance="${instanceId}"]`);
            
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            
            // Update status
            updateInstanceStatus(instanceId, 'running');
            
            // Make API call to start instance
            fetch('/api/mexc/start_instance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update instance ID
                    instances[instanceId].id = data.instance_id;
                    instances[instanceId].running = true;
                    
                    document.getElementById(`instanceId-${instanceId}`).value = data.instance_id;
                    
                    addLogEntry(instanceId, `Market making started for ${config.trading_pair}.`, 'success');
                    
                    // Start mock updates for demo
                    startMockUpdates(instanceId);
                } else {
                    addLogEntry(instanceId, `Error starting market making: ${data.message}`, 'error');
                    updateInstanceStatus(instanceId, 'stopped');
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                }
            })
            .catch(error => {
                addLogEntry(instanceId, `Error: ${error.message}`, 'error');
                updateInstanceStatus(instanceId, 'stopped');
                startButton.style.display = 'block';
                stopButton.style.display = 'none';
            });
        }
        
        // Stop market making
        function stopMarketMaking(instanceId) {
            // Get instance ID
            const instanceIdValue = instances[instanceId].id;
            
            // Update UI
            const startButton = document.querySelector(`.start-button[data-instance="${instanceId}"]`);
            const stopButton = document.querySelector(`.stop-button[data-instance="${instanceId}"]`);
            
            // Make API call to stop instance
            fetch('/api/mexc/stop_instance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ instance_id: instanceIdValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    instances[instanceId].running = false;
                    
                    // Update UI
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                    
                    // Update status
                    updateInstanceStatus(instanceId, 'stopped');
                    
                    addLogEntry(instanceId, 'Market making stopped.', 'info');
                    
                    // Stop mock updates
                    stopMockUpdates(instanceId);
                } else {
                    addLogEntry(instanceId, `Error stopping market making: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLogEntry(instanceId, `Error: ${error.message}`, 'error');
            });
        }
        
        // Update instance
        function updateInstance(instanceId) {
            // Only update if the instance is running
            if (!instances[instanceId].running) {
                return;
            }
            
            // Get form data
            const form = document.getElementById(`mexcForm-${instanceId}`);
            const formData = new FormData(form);
            const config = {};
            
            // Convert form data to JavaScript object
            for (let [key, value] of formData.entries()) {
                // Convert boolean values
                if (value === 'on') {
                    value = true;
                } else if (key.endsWith('Enabled') && !formData.has(key)) {
                    value = false;
                }
                
                // Convert numeric values
                if (!isNaN(value) && value !== '' && !key.includes('Key') && !key.includes('Secret')) {
                    value = parseFloat(value);
                }
                
                config[key] = value;
            }
            
            // Add instance ID
            config.instanceId = instances[instanceId].id;
            config.trading_pair = document.getElementById(`tradingPair-${instanceId}`).value;
            
            // Update the config in the instances object
            instances[instanceId].config = config;
            
            // Make API call to update instance
            fetch('/api/mexc/update_instance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLogEntry(instanceId, `Configuration updated.`, 'info');
                } else {
                    addLogEntry(instanceId, `Error updating configuration: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                addLogEntry(instanceId, `Error: ${error.message}`, 'error');
            });
        }
        
        // Update instance status
        function updateInstanceStatus(instanceId, status) {
            instances[instanceId].status = status;
            
            const statusIndicator = document.getElementById(`statusIndicator-${instanceId}`);
            const statusText = document.getElementById(`statusText-${instanceId}`);
            
            if (status === 'running') {
                statusIndicator.className = 'status-indicator status-running';
                statusText.textContent = 'Running';
            } else if (status === 'stopped') {
                statusIndicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'Stopped';
            } else if (status === 'paused') {
                statusIndicator.className = 'status-indicator status-paused';
                statusText.textContent = 'Paused';
            }
        }
        
        // Add log entry
        function addLogEntry(instanceId, message, type = 'info') {
            const log = document.getElementById(`transactionLog-${instanceId}`);
            
            if (!log) return;
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            // Add timestamp
            const now = new Date();
            const timestamp = `[${now.toLocaleTimeString()}] `;
            
            // Create the message
            entry.textContent = timestamp + message;
            
            // Add to log
            log.appendChild(entry);
            
            // Scroll to bottom
            log.scrollTop = log.scrollHeight;
        }
        
        // Clear transaction log
        function clearTransactionLog(instanceId) {
            const log = document.getElementById(`transactionLog-${instanceId}`);
            log.innerHTML = '<div class="log-entry log-info">Log cleared. Ready for new transactions.</div>';
        }
        
        // Save configuration
        function saveConfig(instanceId) {
            const form = document.getElementById(`mexcForm-${instanceId}`);
            const formData = new FormData(form);
            const config = {};
            
            // Convert form data to JavaScript object
            for (let [key, value] of formData.entries()) {
                // Skip API credentials
                if (key === 'apiKey' || key === 'apiSecret') {
                    continue;
                }
                
                // Convert boolean values
                if (value === 'on') {
                    value = true;
                } else if (key.endsWith('Enabled') && !formData.has(key)) {
                    value = false;
                }
                
                // Convert numeric values
                if (!isNaN(value) && value !== '') {
                    value = parseFloat(value);
                }
                
                config[key] = value;
            }
            
            // Store in localStorage
            localStorage.setItem(`mexcConfig-${instanceId}`, JSON.stringify(config));
        }
        
        // Load saved configuration
        function loadSavedConfig(instanceId) {
            const savedConfig = localStorage.getItem(`mexcConfig-${instanceId}`);
            
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                
                // Populate form fields
                for (const [key, value] of Object.entries(config)) {
                    const element = document.getElementById(`${key}-${instanceId}`);
                    
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value;
                            
                            // Trigger change event for toggle switches
                            if (key.endsWith('Enabled')) {
                                const event = new Event('change');
                                element.dispatchEvent(event);
                            }
                        } else {
                            element.value = value;
                        }
                    }
                }
                
                // Load encrypted credentials
                loadEncryptedCredentials(instanceId);
            }
        }
        
        // Save encrypted credentials
        function saveEncryptedCredentials(instanceId, apiKey, apiSecret) {
            // In a real implementation, this would use encryption.
            // For this demo, we'll just base64 encode the credentials
            const credentials = {
                apiKey,
                apiSecret
            };
            
            const encoded = btoa(JSON.stringify(credentials));
            localStorage.setItem(`mexcCredentials-${instanceId}`, encoded);
        }
        
        // Load encrypted credentials
        function loadEncryptedCredentials(instanceId) {
            const encoded = localStorage.getItem(`mexcCredentials-${instanceId}`);
            
            if (encoded) {
                try {
                    const credentials = JSON.parse(atob(encoded));
                    
                    document.getElementById(`apiKey-${instanceId}`).value = credentials.apiKey;
                    document.getElementById(`apiSecret-${instanceId}`).value = credentials.apiSecret;
                    document.getElementById(`saveCredentials-${instanceId}`).checked = true;
                } catch (error) {
                    console.error('Error loading credentials:', error);
                }
            }
        }
        
        // Mock updates for demo purposes
        function startMockUpdates(instanceId) {
            // Clear any existing interval
            if (instances[instanceId].updateInterval) {
                clearInterval(instances[instanceId].updateInterval);
            }
            
            // Create a new interval
            instances[instanceId].updateInterval = setInterval(() => {
                const events = [
                    { type: 'info', message: 'Refreshing orders...' },
                    { type: 'info', message: 'Checking market conditions...' },
                    { type: 'success', message: 'Order created: Buy 0.001 BTC at 61245.50 USDT' },
                    { type: 'success', message: 'Order created: Sell 0.001 BTC at 61487.25 USDT' },
                    { type: 'info', message: 'Current spread: 0.39%' },
                    { type: 'success', message: 'Order filled: Buy 0.001 BTC at 61245.50 USDT' },
                    { type: 'warning', message: 'Market volatility increasing, adjusting spreads...' },
                    { type: 'error', message: 'API error: Rate limit exceeded, retrying...' },
                    { type: 'success', message: 'Successfully connected to MEXC API' },
                    { type: 'info', message: 'Current balance: 0.0152 BTC, 1245.78 USDT' }
                ];
                
                // Pick a random event
                const event = events[Math.floor(Math.random() * events.length)];
                
                // Add the log entry
                addLogEntry(instanceId, event.message, event.type);
            }, 5000);  // Update every 5 seconds
        }
        
        // Stop mock updates
        function stopMockUpdates(instanceId) {
            if (instances[instanceId].updateInterval) {
                clearInterval(instances[instanceId].updateInterval);
                instances[instanceId].updateInterval = null;
            }
        }
        
        // Add window event listener to check if instances should continue running
        window.addEventListener('beforeunload', function(e) {
            // Check if any instances are running
            for (const instanceId in instances) {
                if (instances[instanceId].running) {
                    // Prompt user before leaving
                    e.preventDefault();
                    e.returnValue = 'You have running market making instances. Are you sure you want to leave?';
                    return e.returnValue;
                }
            }
        });
    });
</script>
{% endblock %}